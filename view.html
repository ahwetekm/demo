<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liste</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        #loadingSpinner {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 20px;
            border-radius: 5px;
            z-index: 1000;
        }
        .error-message {
            color: red;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div id="loadingSpinner">
        <i class="fas fa-spinner fa-spin"></i> İşlem yapılıyor...
    </div>

    <div class="container">
        <header>
            <h1><i class="fas fa-clipboard-list"></i> <span id="listTitleDisplay">ANONİM LİSTE</span></h1>
            <p id="listIdDisplay">Liste ID: <span id="listId"></span></p>
        </header>

        <div id="editControls" style="display: none;">
            <div class="list-controls">
                <input type="text" id="itemName" placeholder="Öğe adı">
                <input type="text" id="itemAmount" placeholder="Miktar">
                <input type="file" id="itemImage" accept="image/*">
                <div id="imageError" class="error-message"></div>
                <button onclick="addItem()"><i class="fas fa-plus"></i> Ekle</button>
            </div>
        </div>

        <div class="list-container">
            <div class="list-header">
                <div class="header-name">Öğe</div>
                <div class="header-amount">Miktar</div>
            </div>
            <div class="list-items" id="itemsList">
                </div>
        </div>

        <div class="actions">
            <button onclick="window.location.href='index.html'" class="secondary">
                <i class="fas fa-plus"></i> Yeni Liste Oluştur
            </button>
        </div>
    </div>

    <script>
        // Firebase Config (index.html ile aynı olmalı)
        const firebaseConfig = {
            apiKey: "AIzaSyCGG5Ur3YpVxbtkjooMxE6r7RPuAmZoFRI",
            authDomain: "anonim-not.firebaseapp.com",
            projectId: "anonim-not",
            storageBucket: "anonim-not.appspot.com",
            messagingSenderId: "1020793266706",
            appId: "1:1020793266706:web:bdaba147c8367a50dfaecb"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let currentListId = '';
        let currentItems = [];
        let hasEditPermission = false;
        const IMGUR_CLIENT_ID = "895f27f2c7a23be"; // Imgur Client ID'niz

        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            currentListId = urlParams.get("id");
            const password = urlParams.get("p");

            document.getElementById("listId").textContent = currentListId;

            if (password) {
                db.collection("lists").doc(currentListId).get()
                    .then(doc => {
                        if (doc.exists) {
                            document.getElementById("listTitleDisplay").textContent = doc.data().title || "İsimsiz Liste";

                            if (doc.data().password === password) {
                                hasEditPermission = true;
                                document.getElementById("editControls").style.display = 'block';
                            } else {
                                document.getElementById("editControls").style.display = 'none';
                            }
                            loadList();
                        }
                    });
            } else {
                document.getElementById("editControls").style.display = 'none';
                db.collection("lists").doc(currentListId).get()
                    .then(doc => {
                        if (doc.exists) {
                            document.getElementById("listTitleDisplay").textContent = doc.data().title || "İsimsiz Liste";
                            loadList();
                        }
                    });
            }
        });

        function loadList() {
            db.collection("lists").doc(currentListId).onSnapshot((doc) => {
                if (doc.exists) {
                    currentItems = doc.data().items || [];
                    renderItems();
                }
            });
        }

        async function uploadImageToImgur(file) {
            showLoading();
            document.getElementById("imageError").textContent = "";

            if (file.size > 10 * 1024 * 1024) {
                hideLoading();
                document.getElementById("imageError").textContent = "Resim boyutu 10MB'tan küçük olmalı!";
                throw new Error("Dosya boyutu aşıldı");
            }

            const formData = new FormData();
            formData.append("image", file);

            try {
                const response = await fetch("https://api.imgur.com/3/image", {
                    method: "POST",
                    headers: {
                        "Authorization": `Client-ID ${IMGUR_CLIENT_ID}`
                    },
                    body: formData
                });

                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.data.error || "Imgur yükleme hatası");
                }
                return data.data.link;
            } catch (error) {
                console.error("Imgur Hatası:", { error: error.message, stack: error.stack });
                document.getElementById("imageError").textContent = "Resim yüklenemedi: " + error.message;
                throw error;
            } finally {
                hideLoading();
            }
        }

        async function addItem() {
            if (!hasEditPermission) return alert("Düzenleme izniniz yok!");

            const name = document.getElementById("itemName").value.trim();
            const amount = document.getElementById("itemAmount").value || "1";
            const imageFile = document.getElementById("itemImage").files[0];
            let imageUrl = null;

            if (!name) return alert("Lütfen öğe adı girin!");

            if (imageFile) {
                try {
                    imageUrl = await uploadImageToImgur(imageFile);
                } catch (error) {
                    return; // Hata mesajı zaten gösterildi
                }
            }

            const newItem = { name, amount, imageUrl: imageUrl };
            const updatedItems = [...currentItems, newItem];

            db.collection("lists").doc(currentListId).update({
                items: updatedItems
            }).then(() => {
                document.getElementById("itemName").value = "";
                document.getElementById("itemAmount").value = "";
                document.getElementById("itemImage").value = "";
            });
        }

        function removeItem(index) {
            if (!hasEditPermission) return alert("Düzenleme izniniz yok!");

            const updatedItems = [...currentItems];
            updatedItems.splice(index, 1);

            db.collection("lists").doc(currentListId).update({
                items: updatedItems
            });
        }

        function renderItems() {
            const container = document.getElementById("itemsList");
            container.innerHTML = '';

            if (currentItems.length === 0) {
                container.innerHTML = "<div class='empty'>Liste boş!</div>";
                return;
            }

            currentItems.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'item';

                let imageHtml = '';
                if (item.imageUrl) {
                    imageHtml = `<div class="item-image-container">
                        <img src="${item.imageUrl}" class="item-image" onerror="this.style.display='none'">
                    </div>`;
                }

                div.innerHTML = `
                    ${imageHtml}
                    <div class="item-details">
                        <div class="item-name">${item.name}</div>
                        <div class="item-amount">${item.amount}</div>
                    </div>
                    ${hasEditPermission ?
                        `<button onclick="removeItem(${index})" class="remove-btn">
                            <i class="fas fa-trash"></i>
                        </button>` : ''
                    }
                `;
                container.appendChild(div);
            });
        }

        function showLoading() {
            document.getElementById("loadingSpinner").style.display = "block";
        }

        function hideLoading() {
            document.getElementById("loadingSpinner").style.display = "none";
        }
    </script>
</body>
</html>