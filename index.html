<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anonim Liste Oluştur</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        #qrcode {
            margin-top: 20px;
            text-align: center;
        }
        #loadingSpinner {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 20px;
            border-radius: 5px;
            z-index: 1000;
        }
        .error-message {
            color: red;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div id="loadingSpinner">
        <i class="fas fa-spinner fa-spin"></i> İşlem yapılıyor...
    </div>

    <div class="container">
        <header>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1><i class="fas fa-clipboard-list"></i> Liste Oluştur</h1>
                    <p>Öğelerinizi ekleyin ve paylaşın</p>
                </div>
                <div>
                    <a href="login.html" class="button secondary">Giriş Yap</a>
                    <a href="register.html" class="button primary">Kayıt Ol</a>
                </div>
            </div>
        </header>

        <div class="list-title-input">
            <input type="text" id="listTitle" placeholder="Liste Başlığı (isteğe bağlı)">
        </div>

        <div class="list-container">
            <div class="list-controls">
                <input type="text" id="itemName" placeholder="Öğe adı">
                <input type="text" id="itemAmount" placeholder="Miktar">
                <input type="file" id="itemImage" accept="image/*">
                <div id="imageError" class="error-message"></div>
                <button onclick="addItem()"><i class="fas fa-plus"></i> Ekle</button>
            </div>
            <div class="list-header">
                <div class="header-name">Öğe</div>
                <div class="header-amount">Miktar</div>
            </div>
            <div class="list-items" id="itemsList">
                <div class="empty">Henüz öğe eklenmedi.</div>
            </div>
        </div>

        <div class="actions">
            <button onclick="shareList()" class="primary"><i class="fas fa-share-alt"></i> Listeyi Paylaş</button>
            <div id="qrcode"></div>
            <div id="shareLinkContainer" style="margin-top: 10px; text-align: center; display: none;">
                <p>Paylaşım Bağlantısı: <a id="shareLink" href="#" target="_blank"></a></p>
            </div>
        </div>
    </div>

    <script>
        // Firebase Config (aynı olmalı)
        const firebaseConfig = {
            apiKey: "AIzaSyCGG5Ur3YpVxbtkjooMxE6r7RPuAmZoFRI",
            authDomain: "anonim-not.firebaseapp.com",
            projectId: "anonim-not",
            storageBucket: "anonim-not.appspot.com",
            messagingSenderId: "1020793266706",
            appId: "1:1020793266706:web:bdaba147c8367a50dfaecb"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const qrcodeDiv = document.getElementById('qrcode');
        const itemsListDiv = document.getElementById('itemsList');
        let items = [];
        const IMGUR_CLIENT_ID = "895f27f2c7a23be"; // Imgur Client ID'niz

        async function uploadImageToImgur(file) {
            showLoading();
            document.getElementById("imageError").textContent = "";

            if (file.size > 10 * 1024 * 1024) {
                hideLoading();
                document.getElementById("imageError").textContent = "Resim boyutu 10MB'tan küçük olmalı!";
                throw new Error("Dosya boyutu aşıldı");
            }

            const formData = new FormData();
            formData.append("image", file);

            try {
                const response = await fetch("https://api.imgur.com/3/image", {
                    method: "POST",
                    headers: {
                        "Authorization": `Client-ID ${IMGUR_CLIENT_ID}`
                    },
                    body: formData
                });

                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.data.error || "Imgur yükleme hatası");
                }
                return data.data.link;
            } catch (error) {
                console.error("Imgur Hatası:", { error: error.message, stack: error.stack });
                document.getElementById("imageError").textContent = "Resim yüklenemedi: " + error.message;
                throw error;
            } finally {
                hideLoading();
            }
        }

        async function addItem() {
            const nameInput = document.getElementById("itemName");
            const amountInput = document.getElementById("itemAmount");
            const imageInput = document.getElementById("itemImage");
            const name = nameInput.value.trim();
            const amount = amountInput.value || "1";
            const imageFile = imageInput.files[0];
            let imageUrl = null;

            if (!name) {htmlame, amount, imageUrl: imageUrl });
            renderItems();
            nameInput.value = "";
            amountInput.value = "";
            imageInput.value = "";
        }

        function removeItem(index) {
            items.splice(index, 1);
            renderItems();
        }

        function renderItems() {
            itemsListDiv.innerHTML = '';
            if (items.length === 0) {
                itemsListDiv.innerHTML = '<div class="empty">Henüz öğe eklenmedi.</div>';
                return;
            }
            items.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'item';
                let imageHtml = '';
                if (item.imageUrl) {
                    imageHtml = `<div class="item-image-container">
                        <img src="${item.imageUrl}" class="item-image" onerror="this.style.display='none'">
                    </div>`;
                }
                div.innerHTML = `
                    ${imageHtml}
                    <div class="item-details">
                        <div class="item-name">${item.name}</div>
                        <div class="item-amount">${item.amount}</div>
                    </div>
                    <button class="remove-btn" onclick="removeItem(${index})"><i class="fas fa-trash"></i></button>
                `;
                itemsListDiv.appendChild(div);
            });
        }

        async function saveListToFirestore(listData) {
            try {
                const docRef = await db.collection("lists").add(listData);
                return docRef.id;
            } catch (error) {
                console.error("Firestore'a yazma hatası:", error);
                alert("Liste kaydedilirken bir hata oluştu.");
                return null;
            }
        }

        async function shareList() {
            if (items.length === 0) {
                alert("Lütfen paylaşmak için önce öğe ekleyin.");
                return;
            }

            const listTitle = document.getElementById("listTitle").value.trim();
            const listData = {
                title: listTitle || "Anonim Liste",
                items: items,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            const listId = await saveListToFirestore(listData);

            if (listId) {
                const shareLink = `${window.location.origin}/view.html?id=${listId}`;
                new QRCode(qrcodeDiv, shareLink);
                document.getElementById("shareLink").href = shareLink;
                document.getElementById("shareLink").textContent = shareLink;
                document.getElementById("shareLinkContainer").style.display = "block";
            }
        }

        function showLoading() {
            document.getElementById("loadingSpinner").style.display = "block";
        }

        function hideLoading() {
            document.getElementById("loadingSpinner").style.display = "none";
        }
    </script>
</body>
</html>